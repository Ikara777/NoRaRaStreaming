<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .donation-settings {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 제목 스타일 */
        .donation-settings h2 {
            font-size: 24px;
            font-weight: 600;
            color: #007bff;
            margin-bottom: 20px;
        }

        .donation-settings p {
            font-size: 16px;
            color: #555;
            margin-bottom: 30px;
        }

        /* 프리셋 컨테이너 */
        .donation-preset {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            font-family: Pretendard, Noto Sans KR,arial, sans-serif;
        }

        /* 모든 자식 요소에 폰트 적용 */
        label, h3, p {
            font-family: Pretendard, Noto Sans KR,arial, sans-serif;
        }

        .donation-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .donation-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .donation-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-donation-btn {
            margin: 20px 0;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .donation-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            display: none;
        }

        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* 색상 입력 필드 스타일 */
        .color-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hex-input {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 120px;
        }

        .color-preview {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>


<th:block layout:fragment="script">
    <script th:inline="javascript">
        // 멤버 정보 가져오기
        const member = [[${member}]];
        const memberId = member.id;  // member ID 저장
        const existingDonations = [[${donations}]];
        let presetCount = 0;

        function removePresetForm(button) {
            const presetDiv = button.closest('.donation-preset');
            if (presetDiv) {
                presetDiv.remove();
            }
        }

        // 페이지 로드 시 기존 프리셋 추가
        document.addEventListener('DOMContentLoaded', function() {
            if (existingDonations && existingDonations.length > 0) {
                existingDonations.forEach(donation => {
                    addPresetForm(donation);
                });
            } else {
                addPresetForm();
            }
        });

        function addPresetForm(existingDonation = null) {
            presetCount++;
            const presetHtml = `
                <div class="donation-preset" data-index="${presetCount}">
                    <h3><i class="fas fa-cogs"></i> 프리셋 ${presetCount} 번</h3>
                    <form class="donation-form">
                        <div class="form-group">
                            <label>후원 금액 구간 설정</label>
                            <input type="number" name="amount" required min="1000"
                                   value="${existingDonation ? existingDonation.amount : ''}">
                        </div>
                        <div class="form-group">
                            <label>후원 메시지</label>
                            <textarea name="message" required>${existingDonation ? existingDonation.message : ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>알림 지속 시간 (초)</label>
                            <input type="number" name="showTime" required min="1" max="10"
                                   value="${existingDonation ? existingDonation.showTime : ''}">
                        </div>

                        <div class="form-group">
                            <label>헤더 색상 (HEX)</label>
                            <div class="color-group">
                                <input type="text" name="headColor" class="hex-input"
                                    placeholder="#000000" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$"
                                    oninput="updateColorPreview(this)"
                                    value="${existingDonation ? existingDonation.headColor : ''}"
                                >
                                <div class="color-preview"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>텍스트 색상 (HEX)</label>
                            <div class="color-group">
                                <input type="text" name="textColor" class="hex-input"
                                    placeholder="#000000" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$"
                                    oninput="updateColorPreview(this)"
                                    value="${existingDonation ? existingDonation.headColor : ''}"
                                >


                                <div class="color-preview"></div>
                            </div>
                        </div>

                        <!-- 이미지 업로드 필드 추가 -->
                        <div class="form-group">
                            <label>알림 이미지</label>
                            <input type="file" name="image" accept="image/*">
                            ${existingDonation && existingDonation.imgUrl ?
                                `<img src="${existingDonation.imgUrl}" alt="현재 이미지" style="max-width: 200px;">` : ''}
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removePresetForm(this)">삭제</button>
                    </form>
                </div>
            `;
            document.getElementById('presetList').insertAdjacentHTML('beforeend', presetHtml);
        }

        function updateColorPreview(input) {
            const preview = input.nextElementSibling;
            if (/^#[0-9A-Fa-f]{6}$/.test(input.value)) {
                preview.style.backgroundColor = input.value;
            }
        }


        function saveAllPresets() {
            const presets = document.querySelectorAll('.donation-preset');
            const formData = new FormData();
            const donationData = {
                memberId: memberId,
                donations: []
            };

            presets.forEach((preset, index) => {
                const form = preset.querySelector('form');
                donationData.donations.push({
                    amount: parseInt(form.querySelector('[name="amount"]').value),
                    message: form.querySelector('[name="message"]').value,
                    showTime: parseInt(form.querySelector('[name="showTime"]').value),
                    headColor: form.querySelector('[name="headColor"]').value,    // 추가
                    textColor: form.querySelector('[name="textColor"]').value     // 추가
                });

                // 이미지 파일이 있으면 추가
                const imgFile = form.querySelector('[name="image"]').files[0];
                if (imgFile) {
                    formData.append(`images`, imgFile);
                }
            });

            formData.append('donationData', JSON.stringify(donationData));

            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            fetch('/donation/set/save', {
                method: 'POST',
                headers: {
                    [header]: token
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert('설정이 저장되었습니다.');
                    location.reload();
                } else {
                    alert('저장 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
        }


    </script>
</th:block>

<div layout:fragment="content" class="content">
    <div class="donation-settings">
        <h2>후원 알림 설정</h2>
        <p>스트리머: <span th:text="${streamerNickname}"></span></p>

        <!-- 프리셋 목록 표시 영역 -->
        <div id="presetList"></div>

        <button type="button" onclick="addPresetForm()" class="btn btn-primary">새 프리셋 추가</button>
        <button type="button" onclick="saveAllPresets()" class="btn btn-success">모든 설정 저장</button>
    </div>
</div>


</html>